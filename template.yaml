AWSTemplateFormatVersion: '2010-09-09'

Description: bryceandryanforeverandever.net

Mappings:
  EnvironmentMap:
    test:
      NakedDomain: test.bryceandryanforeverandever.net
      WwwDomain: www.test.bryceandryanforeverandever.net
    prod:
      NakedDomain: bryceandryanforeverandever.net
      WwwDomain: www.bryceandryanforeverandever.net

Parameters:
  Environment:
    AllowedValues:
      - test
      - prod
    Type: String

  HostedZoneId:
    Type: String

Resources:
  NakedBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !FindInMap
        - EnvironmentMap
        - !Ref Environment
        - NakedDomain
      WebsiteConfiguration:
        IndexDocument: index.html
        RoutingRules:
          - RedirectRule:
              HostName: !FindInMap
                - EnvironmentMap
                - !Ref Environment
                - WwwDomain
              HttpRedirectCode: 301
              Protocol: https

  NakedBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Principal: '*'
            Resource:
              Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Ref: NakedBucket
                  - /*
        Version: '2012-10-17'
      Bucket: !Ref NakedBucket

  NakedCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !FindInMap
        - EnvironmentMap
        - !Ref Environment
        - NakedDomain
      DomainValidationOptions:
        - DomainName: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - NakedDomain
          HostedZoneId: !Ref HostedZoneId
      ValidationMethod: DNS

  NakedDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - NakedDomain
        Comment: !FindInMap
          - EnvironmentMap
          - !Ref Environment
          - NakedDomain
        DefaultCacheBehavior:
          DefaultTTL: 0
          ForwardedValues:
            QueryString: false
          MaxTTL: 0
          TargetOriginId: origin
          ViewerProtocolPolicy: allow-all
        Enabled: true
        # HttpVersion: http2
        # IPV6Enabled: true
        # IsIPV6Enabled: true
        # Logging: {}
        Origins:
          - CustomOriginConfig:
              OriginProtocolPolicy: http-only
            DomainName: !Select
              - 1
              - !Split
                - ://
                - !GetAtt NakedBucket.WebsiteURL
            Id: origin
        ViewerCertificate:
          AcmCertificateArn: !Ref NakedCertificate
          SslSupportMethod: sni-only

  RecordSetGroup:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneName: bryceandryanforeverandever.net.
      RecordSets:
        - AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt NakedDistribution.DomainName
          Name: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - NakedDomain
          Type: A
        - AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt NakedDistribution.DomainName
          Name: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - NakedDomain
          Type: AAAA
        - AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt WwwDistribution.DomainName
          Name: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - WwwDomain
          Type: A
        - AliasTarget:
            HostedZoneId: Z2FDTNDATAQYW2
            DNSName: !GetAtt WwwDistribution.DomainName
          Name: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - WwwDomain
          Type: AAAA

  WwwBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !FindInMap
        - EnvironmentMap
        - !Ref Environment
        - WwwDomain
      WebsiteConfiguration:
        IndexDocument: index.html

  WwwBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:GetObject
            Effect: Allow
            Principal: '*'
            Resource:
              Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - Ref: WwwBucket
                  - /*
        Version: '2012-10-17'
      Bucket: !Ref WwwBucket

  WwwCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !FindInMap
        - EnvironmentMap
        - !Ref Environment
        - WwwDomain
      DomainValidationOptions:
        - DomainName: !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - WwwDomain
          HostedZoneId: !Ref HostedZoneId
      ValidationMethod: DNS

  WwwDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - !FindInMap
            - EnvironmentMap
            - !Ref Environment
            - WwwDomain
        Comment: !FindInMap
          - EnvironmentMap
          - !Ref Environment
          - WwwDomain
        DefaultCacheBehavior:
          DefaultTTL: 0
          ForwardedValues:
            QueryString: false
          MaxTTL: 0
          TargetOriginId: origin
          ViewerProtocolPolicy: redirect-to-https
        Enabled: true
        # HttpVersion: http2
        # IPV6Enabled: true
        # IsIPV6Enabled: true
        # Logging: {}
        Origins:
          - CustomOriginConfig:
              OriginProtocolPolicy: http-only
            DomainName: !Select
              - 1
              - !Split
                - ://
                - !GetAtt WwwBucket.WebsiteURL
            Id: origin
        ViewerCertificate:
          AcmCertificateArn: !Ref WwwCertificate
          SslSupportMethod: sni-only

Outputs:
  NakedCertificateArn:
    Value: !Ref NakedCertificate

  WwwCertificateArn:
    Value: !Ref WwwCertificate
